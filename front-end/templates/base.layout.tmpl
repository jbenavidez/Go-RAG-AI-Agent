{{define "base"}}
 {{/* use Websocket to communicate with the agent  */}}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Capital Projects AI Agent</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <link href="/static/css/styles.css" rel="stylesheet" />
 
</head>

<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">NYC Capital Projects AI Agent</h1>

    <div id="chat-container">
      <div id="flash-message"></div>
    </div>

    <div id="input-area">
      <textarea id="question" class="form-control" rows="2" placeholder="Type your question..."></textarea>
      <button id="submit" class="btn btn-primary mt-2">Send</button>
    </div>

    <div class="text-center text-muted">
      âš¡ Note: Since the AI agent runs locally, responses may take a few seconds.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const questionInput = document.getElementById('question');
    const submitButton = document.getElementById('submit');
    const flashMessage = document.getElementById('flash-message');

    function showFlash(msg, duration = 3000, type = 'info') {
      flashMessage.innerText = msg;
      flashMessage.className = type === 'error' ? 'flash-error' : 'flash-info';
      flashMessage.style.display = 'block';
      setTimeout(() => flashMessage.style.display = 'none', duration);
    }

    function addMessage(text, type) {
      const row = document.createElement('div');
      row.className = `chat-row ${type === 'user-message' ? 'user' : ''}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML = type === 'user-message' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = text;

      msg.appendChild(content);
      row.appendChild(type === 'user-message' ? msg : avatar);
      row.appendChild(type === 'user-message' ? avatar : msg);

      chatContainer.appendChild(row);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return content; // return for typing effect updates
    }

    // --- WebSocket setup ---
    const socket = new WebSocket("ws://localhost:4000/ws-answer-user-question");

    socket.onopen = () => console.log("WebSocket connected");
    socket.onclose = () => console.log("WebSocket closed");
    socket.onerror = (err) => console.error("WebSocket error:", err);

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.action === "answer") {
          // typing effect
          const contentDiv = addMessage("", "ai-message");
          let i = 0;
          const interval = setInterval(() => {
            contentDiv.innerText = data.message.slice(0, i);
            i++;
            if (i > data.message.length) clearInterval(interval);
          }, 20);
        }
      } catch (err) {
        console.error("Invalid JSON from server:", event.data);
      }
    };

    function sendQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      questionInput.disabled = true;
      submitButton.disabled = true;

      addMessage(question, 'user-message');
      questionInput.value = '';

      // send payload via WebSocket
      const payload = { action: "question", message: question };
      socket.send(JSON.stringify(payload));

      // temporary feedback
      addMessage('AI is typing... <span class="spinner-border spinner-border-sm"></span>', 'ai-message');

      setTimeout(() => {
        questionInput.disabled = false;
        submitButton.disabled = false;
        questionInput.focus();
      }, 100); // quickly restore input
    }

    submitButton.onclick = sendQuestion;
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!questionInput.disabled) sendQuestion();
      }
    });

    window.onload = () => {
      addMessage(
        "Hi! Iâ€™m your NYC Capital Projects AI Agent ðŸ¤–. Ask me about any NYC capital projects!",
        'ai-message'
      );
    };
  </script>
</body>
</html>
{{end}}
